<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zabbixå±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        header p {
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #f9f9f9;
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        input[type="text"],
        input[type="password"],
        input[type="datetime-local"],
        select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="password"]:focus,
        input[type="datetime-local"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .hidden {
            display: none;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            overflow-x: auto;
            display: block;
        }

        .data-table table {
            width: 100%;
            min-width: 600px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .data-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .data-table tr:hover {
            background: #f5f5f5;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-size: 1.2em;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        select[multiple] {
            height: 150px;
        }

        .info-text {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .content {
                padding: 15px;
            }

            header h1 {
                font-size: 1.5em;
            }

            .button-group {
                flex-direction: column;
            }

            button {
                width: 100%;
                margin-right: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“Š Zabbixå±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h1>
            <p>Zabbix APIã‚’ä½¿ç”¨ã—ã¦ãƒ’ã‚¹ãƒˆãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</p>
        </header>

        <div class="content">
            <!-- Connection Section -->
            <div class="section">
                <h2>1. Zabbixæ¥ç¶šè¨­å®š</h2>
                <div class="form-group">
                    <label for="zabbixUrl">Zabbix URL:</label>
                    <input type="text" id="zabbixUrl" placeholder="https://zabbix-server.example.com">
                    <div class="info-text">ä¾‹: https://zabbix.example.comï¼ˆ/api_jsonrpc.phpã¯è‡ªå‹•è¿½åŠ ã•ã‚Œã¾ã™ï¼‰</div>
                </div>
                <div class="form-group">
                    <label for="username">ãƒ¦ãƒ¼ã‚¶ãƒ¼å:</label>
                    <input type="text" id="username" placeholder="ç®¡ç†è€…">
                </div>
                <div class="form-group">
                    <label for="password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
                    <input type="password" id="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
                </div>
                <button id="connectBtn" onclick="connectToZabbix()">æ¥ç¶š</button>
                <button id="disconnectBtn" onclick="disconnect()" class="hidden">åˆ‡æ–­</button>
                <div id="connectionStatus" class="status"></div>
            </div>

            <!-- Host Selection Section -->
            <div id="hostSection" class="section hidden">
                <h2>2. ãƒ›ã‚¹ãƒˆé¸æŠ</h2>
                <div class="form-group">
                    <label for="exportMode">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰:</label>
                    <select id="exportMode" onchange="changeExportMode()">
                        <option value="item">å€‹åˆ¥ã‚¢ã‚¤ãƒ†ãƒ é¸æŠ</option>
                        <option value="host">ãƒ›ã‚¹ãƒˆå…¨ä½“ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</option>
                    </select>
                    <div class="info-text">å€‹åˆ¥: ç‰¹å®šã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠ / ãƒ›ã‚¹ãƒˆå…¨ä½“: ã™ã¹ã¦ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</div>
                </div>
                <div class="form-group">
                    <label for="hostSelect">ãƒ›ã‚¹ãƒˆ:</label>
                    <select id="hostSelect" onchange="loadItems()">
                        <option value="">ãƒ›ã‚¹ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                    </select>
                    <div class="info-text" id="hostSelectInfo"></div>
                </div>
                <div id="hostStatus" class="status"></div>
            </div>

            <!-- Item Selection Section -->
            <div id="itemSection" class="section hidden">
                <h2>3. ã‚¢ã‚¤ãƒ†ãƒ é¸æŠ</h2>
                <div class="form-group">
                    <label for="itemSelect">ã‚¢ã‚¤ãƒ†ãƒ  (è¤‡æ•°é¸æŠå¯):</label>
                    <select id="itemSelect" multiple>
                        <option value="">ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                    </select>
                    <div class="info-text">Ctrlã‚­ãƒ¼(ã¾ãŸã¯Cmd)ã‚’æŠ¼ã—ãªãŒã‚‰ã‚¯ãƒªãƒƒã‚¯ã§è¤‡æ•°é¸æŠ</div>
                </div>
                <div id="itemStatus" class="status"></div>
            </div>

            <!-- Time Range Section -->
            <div id="timeSection" class="section hidden">
                <h2>4. æ™‚é–“ç¯„å›²é¸æŠ</h2>
                <div class="form-group">
                    <label for="timeFrom">é–‹å§‹æ™‚åˆ»:</label>
                    <input type="datetime-local" id="timeFrom">
                </div>
                <div class="form-group">
                    <label for="timeTill">çµ‚äº†æ™‚åˆ»:</label>
                    <input type="datetime-local" id="timeTill">
                </div>
                <div class="button-group">
                    <button id="getHistoryBtn" onclick="getHistory()">å±¥æ­´ãƒ‡ãƒ¼ã‚¿å–å¾—</button>
                    <button id="getHostHistoryBtn" onclick="getHostHistory()" class="hidden">ãƒ›ã‚¹ãƒˆå…¨ä½“ã®å±¥æ­´ãƒ‡ãƒ¼ã‚¿å–å¾—</button>
                </div>
                <div id="timeStatus" class="status"></div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="section hidden">
                <h2>5. çµæœ</h2>
                <div class="button-group">
                    <button onclick="exportToCSV()">CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                    <button onclick="exportToJSON()">JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                </div>
                <div id="resultsStatus" class="status"></div>
                <div id="resultsTable" class="data-table"></div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let authToken = null;
        let historyData = [];
        let currentHosts = [];
        let currentItems = [];
        let apiRequestCounter = 0;
        let exportMode = 'item'; // 'item' ã¾ãŸã¯ 'host'

        // Initialize datetime inputs with default values (last 24 hours)
        window.onload = function() {
            const now = new Date();
            const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            
            document.getElementById('timeTill').value = formatDateTimeLocal(now);
            document.getElementById('timeFrom').value = formatDateTimeLocal(yesterday);
        };

        function formatDateTimeLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        function showStatus(elementId, message, type) {
            const statusElement = document.getElementById(elementId);
            // æ”¹è¡Œã‚’<br>ã‚¿ã‚°ã«å¤‰æ›
            statusElement.innerHTML = message.replace(/\n/g, '<br>');
            statusElement.className = `status ${type}`;
            statusElement.style.display = 'block';
        }

        function hideStatus(elementId) {
            const statusElement = document.getElementById(elementId);
            statusElement.style.display = 'none';
        }

        async function callZabbixAPI(method, params) {
            const url = document.getElementById('zabbixUrl').value;
            
            const requestBody = {
                jsonrpc: '2.0',
                method: method,
                params: params,
                id: ++apiRequestCounter
            };

            if (authToken && method !== 'user.login') {
                requestBody.auth = authToken;
            }

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.data || data.error.message);
                }

                return data.result;
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // URLã‚’æ­£è¦åŒ–ï¼ˆ/api_jsonrpc.phpã‚’è‡ªå‹•è¿½åŠ ï¼‰
        function normalizeZabbixUrl(url) {
            if (!url) return url;
            
            // URLã‚’ãƒˆãƒªãƒ 
            url = url.trim();
            
            // æ—¢ã«/api_jsonrpc.phpãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯ãã®ã¾ã¾è¿”ã™
            if (url.includes('/api_jsonrpc.php')) {
                return url;
            }
            
            // æœ«å°¾ã®ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤
            url = url.replace(/\/+$/, '');
            
            // /api_jsonrpc.phpã‚’è¿½åŠ 
            return url + '/api_jsonrpc.php';
        }

        async function connectToZabbix() {
            let url = document.getElementById('zabbixUrl').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!url || !username || !password) {
                showStatus('connectionStatus', 'ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            // URLã‚’æ­£è¦åŒ–ï¼ˆ/api_jsonrpc.phpã‚’è‡ªå‹•è¿½åŠ ï¼‰
            url = normalizeZabbixUrl(url);
            // æ­£è¦åŒ–ã•ã‚ŒãŸURLã‚’å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«åæ˜ 
            document.getElementById('zabbixUrl').value = url;

            showStatus('connectionStatus', 'æ¥ç¶šä¸­...', 'info');

            try {
                authToken = await callZabbixAPI('user.login', {
                    username: username,
                    password: password
                });

                showStatus('connectionStatus', 'æ¥ç¶šæˆåŠŸï¼', 'success');
                
                // Update UI
                document.getElementById('connectBtn').classList.add('hidden');
                document.getElementById('disconnectBtn').classList.remove('hidden');
                document.getElementById('zabbixUrl').disabled = true;
                document.getElementById('username').disabled = true;
                document.getElementById('password').disabled = true;

                // Show next sections
                document.getElementById('hostSection').classList.remove('hidden');
                
                // Load hosts
                await loadHosts();

            } catch (error) {
                let errorMessage = `æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`;
                
                // ã‚ˆã‚Šè©³ã—ã„ã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’æä¾›
                if (error.message.includes('Incorrect user name or password')) {
                    errorMessage = `èªè¨¼ã‚¨ãƒ©ãƒ¼: ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚\n\nç¢ºèªäº‹é …ï¼š\nâ€¢ ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ã„ã‹\nâ€¢ Zabbix Webã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã§åŒã˜èªè¨¼æƒ…å ±ã§ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ã‹\nâ€¢ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ãªã„ã‹`;
                } else if (error.message.includes('temporarily blocked')) {
                    errorMessage = `èªè¨¼ã‚¨ãƒ©ãƒ¼: ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒä¸€æ™‚çš„ã«ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚\n\nå¯¾å‡¦æ–¹æ³•ï¼š\nâ€¢ ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„\nâ€¢ Zabbixç®¡ç†è€…ã«é€£çµ¡ã—ã¦ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã—ã¦ã‚‚ã‚‰ã£ã¦ãã ã•ã„`;
                } else if (error.message.includes('Connection') || error.message.includes('Failed to fetch')) {
                    errorMessage = `æ¥ç¶šã‚¨ãƒ©ãƒ¼: Zabbixã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚\n\nç¢ºèªäº‹é …ï¼š\nâ€¢ URLãŒæ­£ã—ã„ã‹ï¼ˆä¾‹: https://your-serverï¼‰\nâ€¢ Zabbixã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹\nâ€¢ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šãŒæ­£å¸¸ã‹\nâ€¢ CORSãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ã‹`;
                }
                
                showStatus('connectionStatus', errorMessage, 'error');
                authToken = null;
            }
        }

        function disconnect() {
            authToken = null;
            historyData = [];
            currentHosts = [];
            currentItems = [];

            // Reset UI
            document.getElementById('connectBtn').classList.remove('hidden');
            document.getElementById('disconnectBtn').classList.add('hidden');
            document.getElementById('zabbixUrl').disabled = false;
            document.getElementById('username').disabled = false;
            document.getElementById('password').disabled = false;

            // Hide sections
            document.getElementById('hostSection').classList.add('hidden');
            document.getElementById('itemSection').classList.add('hidden');
            document.getElementById('timeSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');

            // Clear selections
            document.getElementById('hostSelect').innerHTML = '<option value="">ãƒ›ã‚¹ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
            document.getElementById('itemSelect').innerHTML = '<option value="">ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
            document.getElementById('resultsTable').innerHTML = '';

            showStatus('connectionStatus', 'åˆ‡æ–­ã—ã¾ã—ãŸ', 'info');
        }

        async function loadHosts() {
            showStatus('hostStatus', 'ãƒ›ã‚¹ãƒˆèª­ã¿è¾¼ã¿ä¸­...', 'info');

            try {
                currentHosts = await callZabbixAPI('host.get', {
                    output: ['hostid', 'host', 'name'],
                    sortfield: 'name'
                });

                const hostSelect = document.getElementById('hostSelect');
                hostSelect.innerHTML = '<option value="">ãƒ›ã‚¹ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>';

                currentHosts.forEach(host => {
                    const option = document.createElement('option');
                    option.value = host.hostid;
                    option.textContent = `${host.name} (${host.host})`;
                    hostSelect.appendChild(option);
                });

                showStatus('hostStatus', `${currentHosts.length}å€‹ã®ãƒ›ã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`, 'success');

            } catch (error) {
                showStatus('hostStatus', `ãƒ›ã‚¹ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        async function loadItems() {
            const hostId = document.getElementById('hostSelect').value;

            if (!hostId) {
                document.getElementById('itemSection').classList.add('hidden');
                return;
            }

            document.getElementById('itemSection').classList.remove('hidden');
            showStatus('itemStatus', 'ã‚¢ã‚¤ãƒ†ãƒ èª­ã¿è¾¼ã¿ä¸­...', 'info');

            try {
                currentItems = await callZabbixAPI('item.get', {
                    output: ['itemid', 'name', 'key_', 'value_type'],
                    hostids: hostId,
                    sortfield: 'name',
                    webitems: false
                });

                const itemSelect = document.getElementById('itemSelect');
                itemSelect.innerHTML = '';

                currentItems.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.itemid;
                    option.textContent = `${item.name} (${item.key_})`;
                    option.dataset.valueType = item.value_type;
                    itemSelect.appendChild(option);
                });

                showStatus('itemStatus', `${currentItems.length}å€‹ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`, 'success');
                document.getElementById('timeSection').classList.remove('hidden');

            } catch (error) {
                showStatus('itemStatus', `ã‚¢ã‚¤ãƒ†ãƒ èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        function changeExportMode() {
            exportMode = document.getElementById('exportMode').value;
            const hostSelect = document.getElementById('hostSelect');
            const hostSelectInfo = document.getElementById('hostSelectInfo');
            const itemSection = document.getElementById('itemSection');
            const timeSection = document.getElementById('timeSection');
            const getHistoryBtn = document.getElementById('getHistoryBtn');
            const getHostHistoryBtn = document.getElementById('getHostHistoryBtn');

            if (exportMode === 'host') {
                // ãƒ›ã‚¹ãƒˆå…¨ä½“ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰
                hostSelect.multiple = true;
                hostSelect.size = 8;
                hostSelectInfo.textContent = 'Ctrlã‚­ãƒ¼(ã¾ãŸã¯Cmd)ã‚’æŠ¼ã—ãªãŒã‚‰ã‚¯ãƒªãƒƒã‚¯ã§è¤‡æ•°ãƒ›ã‚¹ãƒˆé¸æŠå¯';
                hostSelect.onchange = null; // ãƒ›ã‚¹ãƒˆå…¨ä½“ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã‚¢ã‚¤ãƒ†ãƒ èª­ã¿è¾¼ã¿ãŒä¸è¦ãªã®ã§onchangeã‚¤ãƒ™ãƒ³ãƒˆã‚’ç„¡åŠ¹åŒ–
                itemSection.classList.add('hidden');
                timeSection.classList.remove('hidden');
                getHistoryBtn.classList.add('hidden');
                getHostHistoryBtn.classList.remove('hidden');
            } else {
                // å€‹åˆ¥ã‚¢ã‚¤ãƒ†ãƒ é¸æŠãƒ¢ãƒ¼ãƒ‰
                hostSelect.multiple = false;
                hostSelect.size = 1;
                hostSelectInfo.textContent = '';
                hostSelect.onchange = loadItems;
                itemSection.classList.add('hidden');
                timeSection.classList.add('hidden');
                getHistoryBtn.classList.remove('hidden');
                getHostHistoryBtn.classList.add('hidden');
            }
        }

        async function getHostHistory() {
            const hostSelect = document.getElementById('hostSelect');
            const selectedOptions = Array.from(hostSelect.selectedOptions);

            if (selectedOptions.length === 0) {
                showStatus('timeStatus', 'ãƒ›ã‚¹ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }

            const timeFrom = document.getElementById('timeFrom').value;
            const timeTill = document.getElementById('timeTill').value;

            if (!timeFrom || !timeTill) {
                showStatus('timeStatus', 'æ™‚é–“ç¯„å›²ã‚’æŒ‡å®šã—ã¦ãã ã•ã„', 'error');
                return;
            }

            const timeFromUnix = Math.floor(new Date(timeFrom).getTime() / 1000);
            const timeTillUnix = Math.floor(new Date(timeTill).getTime() / 1000);

            if (timeFromUnix >= timeTillUnix) {
                showStatus('timeStatus', 'é–‹å§‹æ™‚åˆ»ã¯çµ‚äº†æ™‚åˆ»ã‚ˆã‚Šå‰ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™', 'error');
                return;
            }

            showStatus('timeStatus', 'ãƒ›ã‚¹ãƒˆã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’å–å¾—ä¸­...', 'info');
            historyData = [];

            try {
                // é¸æŠã•ã‚ŒãŸãƒ›ã‚¹ãƒˆã®ã™ã¹ã¦ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’å–å¾—
                const selectedHostIds = selectedOptions.map(opt => opt.value);
                
                // ãƒ›ã‚¹ãƒˆIDã¨åå‰ã®ãƒãƒƒãƒ—ã‚’ä½œæˆï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ï¼‰
                const hostNameMap = new Map();
                selectedOptions.forEach(opt => {
                    hostNameMap.set(opt.value, opt.textContent);
                });
                
                for (const hostId of selectedHostIds) {
                    const hostName = hostNameMap.get(hostId);
                    
                    // ãƒ›ã‚¹ãƒˆã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’å–å¾—
                    const items = await callZabbixAPI('item.get', {
                        output: ['itemid', 'name', 'key_', 'value_type'],
                        hostids: hostId,
                        sortfield: 'name',
                        webitems: false
                    });

                    showStatus('timeStatus', `${hostName} ã®å±¥æ­´ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­... (${items.length}å€‹ã®ã‚¢ã‚¤ãƒ†ãƒ )`, 'info');

                    // å„ã‚¢ã‚¤ãƒ†ãƒ ã®å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’ä¸¦åˆ—å–å¾—ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ï¼‰
                    const historyPromises = items.map(item => 
                        callZabbixAPI('history.get', {
                            output: 'extend',
                            history: parseInt(item.value_type),
                            itemids: item.itemid,
                            sortfield: 'clock',
                            sortorder: 'ASC',
                            time_from: timeFromUnix,
                            time_till: timeTillUnix
                        }).then(history => ({ item, history }))
                    );

                    const results = await Promise.all(historyPromises);

                    results.forEach(({ item, history }) => {
                        history.forEach(record => {
                            historyData.push({
                                hostName: hostName,
                                itemId: item.itemid,
                                itemName: item.name,
                                itemKey: item.key_,
                                clock: record.clock,
                                timestamp: new Date(record.clock * 1000).toLocaleString('ja-JP', {
                                    year: 'numeric',
                                    month: '2-digit',
                                    day: '2-digit',
                                    hour: '2-digit',
                                    minute: '2-digit',
                                    second: '2-digit',
                                    hour12: false
                                }),
                                value: record.value,
                                ns: record.ns
                            });
                        });
                    });
                }

                showStatus('timeStatus', `${historyData.length}ä»¶ã®å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸã€‚CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚`, 'success');
                // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šã®ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ã‚’ç”»é¢ã«è¡¨ç¤ºã—ã¾ã›ã‚“
                // displayResults();
                
                // çµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºï¼ˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®ãŸã‚ï¼‰
                document.getElementById('resultsSection').classList.remove('hidden');
                showStatus('resultsStatus', `${historyData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸã€‚è¡¨ç¤ºã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¦ã„ã¾ã™ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šã®ãŸã‚ï¼‰ã€‚CSVã¾ãŸã¯JSONã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚`, 'info');

            } catch (error) {
                showStatus('timeStatus', `å±¥æ­´ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }


        async function getHistory() {
            const itemSelect = document.getElementById('itemSelect');
            const selectedOptions = Array.from(itemSelect.selectedOptions);

            if (selectedOptions.length === 0) {
                showStatus('timeStatus', 'ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }

            const timeFrom = document.getElementById('timeFrom').value;
            const timeTill = document.getElementById('timeTill').value;

            if (!timeFrom || !timeTill) {
                showStatus('timeStatus', 'æ™‚é–“ç¯„å›²ã‚’æŒ‡å®šã—ã¦ãã ã•ã„', 'error');
                return;
            }

            const timeFromUnix = Math.floor(new Date(timeFrom).getTime() / 1000);
            const timeTillUnix = Math.floor(new Date(timeTill).getTime() / 1000);

            if (timeFromUnix >= timeTillUnix) {
                showStatus('timeStatus', 'é–‹å§‹æ™‚åˆ»ã¯çµ‚äº†æ™‚åˆ»ã‚ˆã‚Šå‰ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™', 'error');
                return;
            }

            showStatus('timeStatus', 'å±¥æ­´ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...', 'info');
            historyData = [];

            try {
                // é¸æŠã•ã‚ŒãŸãƒ›ã‚¹ãƒˆåã‚’å–å¾—
                const hostSelect = document.getElementById('hostSelect');
                const selectedHostOption = hostSelect.options[hostSelect.selectedIndex];
                const hostName = selectedHostOption ? selectedHostOption.textContent : '';

                for (const option of selectedOptions) {
                    const itemId = option.value;
                    const valueType = option.dataset.valueType;
                    const itemName = option.textContent;

                    const history = await callZabbixAPI('history.get', {
                        output: 'extend',
                        history: parseInt(valueType),
                        itemids: itemId,
                        sortfield: 'clock',
                        sortorder: 'ASC',
                        time_from: timeFromUnix,
                        time_till: timeTillUnix
                    });

                    history.forEach(record => {
                        historyData.push({
                            hostName: hostName,
                            itemId: itemId,
                            itemName: itemName,
                            clock: record.clock,
                            timestamp: new Date(record.clock * 1000).toLocaleString('ja-JP', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit',
                                hour12: false
                            }),
                            value: record.value,
                            ns: record.ns
                        });
                    });
                }

                showStatus('timeStatus', `${historyData.length}ä»¶ã®å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸã€‚CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚`, 'success');
                // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šã®ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ã‚’ç”»é¢ã«è¡¨ç¤ºã—ã¾ã›ã‚“
                // displayResults();
                
                // çµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºï¼ˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®ãŸã‚ï¼‰
                document.getElementById('resultsSection').classList.remove('hidden');
                showStatus('resultsStatus', `${historyData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸã€‚è¡¨ç¤ºã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¦ã„ã¾ã™ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šã®ãŸã‚ï¼‰ã€‚CSVã¾ãŸã¯JSONã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚`, 'info');

            } catch (error) {
                showStatus('timeStatus', `å±¥æ­´ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        function displayResults() {
            const resultsSection = document.getElementById('resultsSection');
            const resultsTable = document.getElementById('resultsTable');

            if (historyData.length === 0) {
                resultsTable.innerHTML = '<p class="info-text">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                resultsSection.classList.remove('hidden');
                return;
            }

            let tableHTML = '<table><thead><tr>';
            // ãƒ›ã‚¹ãƒˆå…¨ä½“ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã®å ´åˆã¯ãƒ›ã‚¹ãƒˆåã¨ã‚¢ã‚¤ãƒ†ãƒ ã‚­ãƒ¼ã‚‚è¡¨ç¤º
            if (exportMode === 'host') {
                tableHTML += '<th>ãƒ›ã‚¹ãƒˆ</th>';
                tableHTML += '<th>ã‚¢ã‚¤ãƒ†ãƒ </th>';
                tableHTML += '<th>ã‚­ãƒ¼</th>';
                tableHTML += '<th>ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—</th>';
                tableHTML += '<th>å€¤</th>';
            } else {
                tableHTML += '<th>ãƒ›ã‚¹ãƒˆ</th>';
                tableHTML += '<th>ã‚¢ã‚¤ãƒ†ãƒ </th>';
                tableHTML += '<th>ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—</th>';
                tableHTML += '<th>å€¤</th>';
            }
            tableHTML += '</tr></thead><tbody>';

            historyData.forEach(record => {
                tableHTML += '<tr>';
                if (exportMode === 'host') {
                    tableHTML += `<td>${escapeHtml(record.hostName || '')}</td>`;
                    tableHTML += `<td>${escapeHtml(record.itemName)}</td>`;
                    tableHTML += `<td>${escapeHtml(record.itemKey || '')}</td>`;
                    tableHTML += `<td>${escapeHtml(record.timestamp)}</td>`;
                    tableHTML += `<td>${escapeHtml(record.value)}</td>`;
                } else {
                    tableHTML += `<td>${escapeHtml(record.hostName || '')}</td>`;
                    tableHTML += `<td>${escapeHtml(record.itemName)}</td>`;
                    tableHTML += `<td>${escapeHtml(record.timestamp)}</td>`;
                    tableHTML += `<td>${escapeHtml(record.value)}</td>`;
                }
                tableHTML += '</tr>';
            });

            tableHTML += '</tbody></table>';
            resultsTable.innerHTML = tableHTML;
            resultsSection.classList.remove('hidden');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = String(text || '');
            return div.innerHTML;
        }

        async function exportToCSV() {
            if (historyData.length === 0) {
                showStatus('resultsStatus', 'ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            // CompressionStream APIã®ã‚µãƒãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯
            if (!('CompressionStream' in window)) {
                showStatus('resultsStatus', 'ã‚¨ãƒ©ãƒ¼: ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯CompressionStream APIã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚Chrome 80+, Edge 80+, Safari 16.4+ãŒå¿…è¦ã§ã™ã€‚', 'error');
                console.error('CompressionStream API is not supported');
                return;
            }

            showStatus('resultsStatus', 'CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆä¸­...', 'info');

            try {
                // ã‚¢ã‚¤ãƒ†ãƒ ã”ã¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
                const itemGroups = {};
                historyData.forEach(record => {
                    const itemKey = `${record.itemId}_${record.itemName}`;
                    if (!itemGroups[itemKey]) {
                        itemGroups[itemKey] = {
                            itemName: record.itemName,
                            itemKey: record.itemKey,
                            hostName: record.hostName,
                            data: []
                        };
                    }
                    itemGroups[itemKey].data.push(record);
                });

                const itemCount = Object.keys(itemGroups).length;

                // ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆï¼ˆãƒã‚¤ãƒ†ã‚£ãƒ–APIä½¿ç”¨ï¼‰
                showStatus('resultsStatus', 'ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆä¸­...', 'info');
                const zipBlob = await createZipFile(itemGroups);

                // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å«ã‚€ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆ
                const now = new Date();
                const timestamp = now.toISOString().replace(/[-:]/g, '').replace('T', '-').split('.')[0];
                const zipFilename = `zabbix-history-export-${timestamp}.zip`;

                // ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                downloadFile(zipBlob, zipFilename, 'application/zip');
                showStatus('resultsStatus', `${itemCount}å€‹ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ZIPã«ã¾ã¨ã‚ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ`, 'success');
            } catch (error) {
                showStatus('resultsStatus', `ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error('Export error:', error);
            }
        }

        // CompressionStream APIã‚’ä½¿ç”¨ã—ã¦ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
        async function createZipFile(itemGroups) {
            const encoder = new TextEncoder();
            const files = [];
            
            // å„CSVãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã¨ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
            Object.entries(itemGroups).forEach(([key, group]) => {
                let csv = '\uFEFF'; // UTF-8 BOM for Excel compatibility with Japanese characters
                
                // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
                if (exportMode === 'host') {
                    csv += 'ã‚¢ã‚¤ãƒ†ãƒ ,ã‚­ãƒ¼,ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—,å€¤\n';
                } else {
                    csv += 'ã‚¢ã‚¤ãƒ†ãƒ ,ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—,å€¤\n';
                }

                group.data.forEach(record => {
                    if (exportMode === 'host') {
                        csv += `"${record.itemName}","${record.itemKey || ''}","${record.timestamp}","${record.value}"\n`;
                    } else {
                        csv += `"${record.itemName}","${record.timestamp}","${record.value}"\n`;
                    }
                });

                // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆï¼ˆã‚¢ã‚¤ãƒ†ãƒ åã‚’å«ã‚€ï¼‰
                const safeItemName = group.itemName.replace(/[^a-zA-Z0-9\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/g, '_');
                const safeHostName = (group.hostName || 'unknown').replace(/[^a-zA-Z0-9\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/g, '_');
                const filename = `${safeHostName}_${safeItemName}.csv`;

                files.push({
                    name: filename,
                    content: encoder.encode(csv)
                });
            });

            // ZIPå½¢å¼ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åŒ–
            return await generateZip(files);
        }

        // ZIPå½¢å¼ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆï¼ˆCompressionStreamä½¿ç”¨ï¼‰
        async function generateZip(files) {
            const zipParts = [];
            const centralDirectory = [];
            let offset = 0;

            // å„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ZIPã«è¿½åŠ 
            for (const file of files) {
                const filename = new TextEncoder().encode(file.name);
                const content = file.content;
                const crc32 = calculateCRC32(content);
                const modTime = dosDateTime(new Date());

                // åœ§ç¸®
                const compressed = await compressData(content);

                // Local file header
                const localHeader = new Uint8Array(30 + filename.length);
                const view = new DataView(localHeader.buffer);
                
                view.setUint32(0, 0x04034b50, true); // Local file header signature
                view.setUint16(4, 20, true); // Version needed to extract (2.0)
                view.setUint16(6, 0, true); // General purpose bit flag
                view.setUint16(8, 8, true); // Compression method (8 = deflate)
                view.setUint16(10, modTime & 0xFFFF, true); // File last mod time
                view.setUint16(12, (modTime >> 16) & 0xFFFF, true); // File last mod date
                view.setUint32(14, crc32, true); // CRC-32
                view.setUint32(18, compressed.length, true); // Compressed size
                view.setUint32(22, content.length, true); // Uncompressed size
                view.setUint16(26, filename.length, true); // Filename length
                view.setUint16(28, 0, true); // Extra field length
                localHeader.set(filename, 30);

                zipParts.push(localHeader);
                zipParts.push(compressed);

                // Central directory entry
                centralDirectory.push({
                    filename: filename,
                    crc32: crc32,
                    compressedSize: compressed.length,
                    uncompressedSize: content.length,
                    offset: offset,
                    modTime: modTime
                });

                offset += localHeader.length + compressed.length;
            }

            // Central directory
            const centralDirParts = [];
            for (const entry of centralDirectory) {
                const cdHeader = new Uint8Array(46 + entry.filename.length);
                const view = new DataView(cdHeader.buffer);
                
                view.setUint32(0, 0x02014b50, true); // Central directory file header signature
                view.setUint16(4, 20, true); // Version made by
                view.setUint16(6, 20, true); // Version needed to extract
                view.setUint16(8, 0, true); // General purpose bit flag
                view.setUint16(10, 8, true); // Compression method
                view.setUint16(12, entry.modTime & 0xFFFF, true); // File last mod time
                view.setUint16(14, (entry.modTime >> 16) & 0xFFFF, true); // File last mod date
                view.setUint32(16, entry.crc32, true); // CRC-32
                view.setUint32(20, entry.compressedSize, true); // Compressed size
                view.setUint32(24, entry.uncompressedSize, true); // Uncompressed size
                view.setUint16(28, entry.filename.length, true); // Filename length
                view.setUint16(30, 0, true); // Extra field length
                view.setUint16(32, 0, true); // File comment length
                view.setUint16(34, 0, true); // Disk number start
                view.setUint16(36, 0, true); // Internal file attributes
                view.setUint32(38, 0, true); // External file attributes
                view.setUint32(42, entry.offset, true); // Relative offset of local header
                cdHeader.set(entry.filename, 46);
                
                centralDirParts.push(cdHeader);
            }

            const centralDirData = new Uint8Array(centralDirParts.reduce((sum, part) => sum + part.length, 0));
            let cdOffset = 0;
            for (const part of centralDirParts) {
                centralDirData.set(part, cdOffset);
                cdOffset += part.length;
            }

            // End of central directory record
            const eocd = new Uint8Array(22);
            const eocdView = new DataView(eocd.buffer);
            eocdView.setUint32(0, 0x06054b50, true); // End of central dir signature
            eocdView.setUint16(4, 0, true); // Number of this disk
            eocdView.setUint16(6, 0, true); // Disk where central directory starts
            eocdView.setUint16(8, files.length, true); // Number of central directory records on this disk
            eocdView.setUint16(10, files.length, true); // Total number of central directory records
            eocdView.setUint32(12, centralDirData.length, true); // Size of central directory
            eocdView.setUint32(16, offset, true); // Offset of start of central directory
            eocdView.setUint16(20, 0, true); // Comment length

            // ã™ã¹ã¦ã®ãƒ‘ãƒ¼ãƒ„ã‚’çµåˆ
            return new Blob([...zipParts, centralDirData, eocd], { type: 'application/zip' });
        }

        // CompressionStreamã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’åœ§ç¸®
        async function compressData(data) {
            const stream = new Blob([data]).stream();
            const compressedStream = stream.pipeThrough(new CompressionStream('deflate-raw'));
            const blob = await new Response(compressedStream).blob();
            return new Uint8Array(await blob.arrayBuffer());
        }

        // CRC32ãƒã‚§ãƒƒã‚¯ã‚µãƒ ã‚’è¨ˆç®—
        function calculateCRC32(data) {
            const crcTable = [];
            for (let i = 0; i < 256; i++) {
                let c = i;
                for (let j = 0; j < 8; j++) {
                    c = (c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1);
                }
                crcTable[i] = c;
            }

            let crc = 0xFFFFFFFF;
            for (let i = 0; i < data.length; i++) {
                crc = crcTable[(crc ^ data[i]) & 0xFF] ^ (crc >>> 8);
            }
            return (crc ^ 0xFFFFFFFF) >>> 0;
        }

        // DOSæ—¥æ™‚å½¢å¼ã«å¤‰æ›
        function dosDateTime(date) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const hours = date.getHours();
            const minutes = date.getMinutes();
            const seconds = Math.floor(date.getSeconds() / 2);

            const dosDate = ((year - 1980) << 9) | (month << 5) | day;
            const dosTime = (hours << 11) | (minutes << 5) | seconds;

            return (dosDate << 16) | dosTime;
        }
                const timestamp = now.toISOString().replace(/[-:]/g, '').replace('T', '-').split('.')[0];
                const zipFilename = `zabbix-history-export-${timestamp}.zip`;

                // ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                downloadFile(zipBlob, zipFilename, 'application/zip');
                showStatus('resultsStatus', `${itemCount}å€‹ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ZIPã«ã¾ã¨ã‚ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ`, 'success');
            } catch (error) {
                showStatus('resultsStatus', `ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error('Export error:', error);
            }
        }

        function exportToJSON() {
            if (historyData.length === 0) {
                showStatus('resultsStatus', 'ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            const json = JSON.stringify(historyData, null, 2);
            downloadFile(json, 'zabbix-history-export.json', 'application/json');
            showStatus('resultsStatus', 'JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
        }

        function downloadFile(content, filename, mimeType) {
            // contentãŒæ—¢ã«Blobã®å ´åˆã¯ãã®ã¾ã¾ä½¿ç”¨ã€ãã†ã§ãªã‘ã‚Œã°Blobã‚’ä½œæˆ
            const blob = content instanceof Blob ? content : new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
